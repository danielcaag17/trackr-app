{% extends 'base.html' %}
{% load static %}
{% block title %}Detected Video - Trackr{% endblock %}

{% block head %}
    <script src="{% static 'js/show_details.js' %}"></script>
{% endblock %}

{% block content %}
    <main class="main-detect-video">
        <div style="text-align: center; margin-bottom: 20px;"></div>
        <div style="text-align: center; margin-bottom: 20px;">
            <video width="640" height="360" controls>
                <source src="{{ video.public_url }}" type="video/mp4">
                Tu navegador no soporta video HTML5.
            </video>
            <p style="font-size: 14px; color: #6b7280; margin-top: 10px;">
                <em>{{ video.title }}</em><br>
            </p>
        </div>

        <!-- Contenedor de estadísticas agrupadas -->
        <div style="display: flex; justify-content: space-around; background-color: #f3f4f6; border-radius: 10px; padding: 15px; flex-wrap: wrap; gap: 15px; text-align: center;">
            <div style="min-width: 100px;">
                <div style="font-size: 24px; font-weight: 700;">{{ video.people_detected }}</div>
                <div style="font-size: 14px; color: #4b5563;">People<br>Detected</div>
            </div>
            <div style="min-width: 100px;">
                <div style="font-size: 24px; font-weight: 700;">{{ video.avg_people_per_frame }}</div>
                <div style="font-size: 14px; color: #4b5563;">Average people<br>per frame</div>
            </div>
            <div style="min-width: 100px;">
                <div style="font-size: 24px; font-weight: 700;">{{ video.person_presence_percent|floatformat:2 }}%</div>
                <div style="font-size: 14px; color: #4b5563;">Person Presence</div>
            </div>
        </div>
        <div></div>

        <!-- Estadísticas del video -->
        <div style="text-align: center; margin-top: 20px;">
            <button id="toggle-info-btn" onclick="toggleInfoDetails()" class="toggle-btn">
                Show additional stats
            </button>
        </div>

        <div id="stats-details" class="model-details-collapsed">
            <div class="stats-card">
                <h3 class="stats-title">Video Stats</h3>
                <ul class="stats-list">
                    <li><strong>Frames processed:</strong> {{ video.frame_processed }}</li>
                    <li><strong>Video duration:</strong> {{ video.video_duration }} sec</li>
                    <li><strong>Frame rate:</strong> {{ video.video_fps }} fps</li>
                    <li><strong>Processing time:</strong> {{ video.processing_time_seconds }} sec</li>
                    <li><strong>Confidence threshold:</strong> {{ video.confidence_threshold }}</li>
                </ul>
            </div>
            <div class="stats-card">
                <h3 class="stats-title">Model Analysis</h3>
                <ul class="stats-list">
                    <li><strong>Total detections:</strong> {{ video.total_detections }}</li>
                    <li><strong>Detections discarded:</strong> {{ video.detections_discarded }}</li>
                    <li><strong>Frames with detections:</strong> {{ video.frames_with_detections }}</li>
                    <li><strong>People detected:</strong> {{ video.people_detected }}</li>
                    <li><strong>Average confidence:</strong> {{ video.avg_confidence|floatformat:4 }}</li>
                    <li><strong>Average people per frame:</strong> {{ video.avg_people_per_frame }}</li>
                    <li><strong>Person presence:</strong> {{ video.person_presence_percent|floatformat:2 }}%</li>
                    <li><strong>Peak people in frame:</strong> {{ video.peak_count }} <span class="muted">(frame #{{ video.peak_frame_id }})</span></li>
                </ul>
            </div>
        </div>

        <!-- Botón para mostrar detalles del modelo -->
        <div style="text-align: center; margin-top: 20px;">
            <button id="toggle-model-btn" onclick="toggleModelDetails()" class="toggle-btn">
                Show model details
            </button>
        </div>

        <!-- Panel animado, se puede poner tambien encima del botón -->
        <div id="model-details" class="model-details-collapsed">
            <div class="stats-card">
                <h3 class="stats-title">Model Metrics</h3>
                <ul class="stats-list">
                    <li><strong>Model name:</strong> {{ ml_model.model_name }}</li>
                    <li><strong>Description:</strong> {{ ml_model.description}}</li>

                    <li><strong>Train box loss:</strong> {{ model_metrics.train_box_loss|floatformat:4 }}</li>
                    <li><strong>Train classification loss:</strong> {{ model_metrics.train_cls_loss|floatformat:4 }}</li>
                    <li><strong>Train distributed focal loss:</strong> {{ model_metrics.train_dfl_loss|floatformat:4 }}</li>

                    <li><strong>Validation box loss:</strong> {{ model_metrics.val_box_loss|floatformat:4 }}</li>
                    <li><strong>Validation classification loss:</strong> {{ model_metrics.val_cls_loss|floatformat:4 }}</li>
                    <li><strong>Validation distributed focal loss:</strong> {{ model_metrics.val_dfl_loss|floatformat:4 }}</li>

                    <li><strong>Validation Precision:</strong> {{ model_metrics.val_precision|floatformat:4 }}</li>
                    <li><strong>Validation Recall:</strong> {{ model_metrics.val_recall|floatformat:4 }}</li>
                    <li><strong>Validation mAP50:</strong> {{ model_metrics.val_map50|floatformat:4 }}</li>
                    <li><strong>Validation mAP50-95:</strong> {{ model_metrics.val_map50_95|floatformat:4 }}</li>
                </ul>
            </div>

            <div class="stats-card">
                <h3 class="stats-title">Tracker info</h3>
                <ul class="stats-list">
                    <li><strong>IOU Threshold:</strong> {{ tracker.iou_threshold }}</li>
                    <li><strong>Max Age:</strong> {{ tracker.max_age }}</li>
                    <li><strong>Min Hits:</strong> {{ tracker.min_hits }}</li>
                </ul>
            </div>
        </div>
    </main>
{% endblock %}
